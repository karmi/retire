<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>tire.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>tire.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p><strong>Tire</strong> provides rich and comfortable Ruby API for the
<a href="http://www.elasticsearch.org/"><em>ElasticSearch</em></a> search engine/database.</p>

<p><em>ElasticSearch</em> is a scalable, distributed, cloud-ready, highly-available
full-text search engine and database, communicating by JSON over RESTful HTTP,
based on <a href="http://lucene.apache.org/">Lucene</a>, written in Java.</p>

<p><img src="http://github.com/favicon.ico" style="position:relative; top:2px">
<em>Tire</em> is open source, and you can download or clone the source code
from <a href="https://github.com/karmi/tire">https://github.com/karmi/tire</a>.</p>

<p>By following these instructions you should have the search running
on a sane operation system in less then 10 minutes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Note, that this file can be executed directly:</p>

<pre><code>ruby -I lib examples/tire-dsl.rb
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Installation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Installation">&#182;</a>
        </div>
        <h3>Installation</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Install <em>Tire</em> with <em>Rubygems</em>:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <pre><code>gem install tire
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p><em>Tire</em> uses the <a href="https://github.com/intridea/multi_json"><em>multi_json</em></a> gem as a generic JSON library.
We want to use the <a href="https://github.com/brianmario/yajl-ruby"><em>yajl-ruby</em></a> gem in its full on mode here.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;yajl/json_gem&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Now, let&rsquo;s require the <em>Tire</em> gem itself, and we&rsquo;re ready to go.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;tire&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-Prerequisites'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Prerequisites">&#182;</a>
        </div>
        <h3>Prerequisites</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>We&rsquo;ll need a working and running <em>ElasticSearch</em> server, of course. Thankfully, that&rsquo;s easy.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="p">(</span> <span class="nb">puts</span> <span class="o">&lt;&lt;-</span><span class="sh">&quot;</span><span class="no">INSTALL</span><span class="sh">&quot;</span> <span class="p">;</span> <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="k">unless</span> <span class="p">(</span><span class="no">RestClient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://localhost:9200&#39;</span><span class="p">)</span> <span class="k">rescue</span> <span class="kp">false</span><span class="p">)</span>

<span class="sh"> [ERROR] You don’t appear to have ElasticSearch installed. Please install and launch it with the following commands:</span>

<span class="sh"> curl -k -L -o elasticsearch-0.16.0.tar.gz http://github.com/downloads/elasticsearch/elasticsearch/elasticsearch-0.16.0.tar.gz</span>
<span class="sh"> tar -zxvf elasticsearch-0.16.0.tar.gz</span>
<span class="sh"> ./elasticsearch-0.16.0/bin/elasticsearch -f</span>
<span class="no">INSTALL</span></pre></div>
      </td>
    </tr>
    <tr id='section-Storing_and_indexing_documents'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Storing_and_indexing_documents">&#182;</a>
        </div>
        <h2>Storing and indexing documents</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Let&rsquo;s initialize an index named “articles”.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Tire</span><span class="o">.</span><span class="n">index</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>To make sure it&rsquo;s fresh, let&rsquo;s delete any existing index with the same name.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">delete</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>And then, let&rsquo;s create it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">create</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>We want to store and index some articles with <code>title</code>, <code>tags</code> and <code>published_on</code> properties.
Simple Hashes are OK.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">store</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;One&#39;</span><span class="p">,</span>   <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="o">]</span><span class="p">,</span>           <span class="ss">:published_on</span> <span class="o">=&gt;</span> <span class="s1">&#39;2011-01-01&#39;</span>
  <span class="n">store</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;Two&#39;</span><span class="p">,</span>   <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:published_on</span> <span class="o">=&gt;</span> <span class="s1">&#39;2011-01-02&#39;</span>
  <span class="n">store</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;Three&#39;</span><span class="p">,</span> <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;java&#39;</span><span class="o">]</span><span class="p">,</span>           <span class="ss">:published_on</span> <span class="o">=&gt;</span> <span class="s1">&#39;2011-01-02&#39;</span>
  <span class="n">store</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;Four&#39;</span><span class="p">,</span>  <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;php&#39;</span><span class="o">]</span><span class="p">,</span>    <span class="ss">:published_on</span> <span class="o">=&gt;</span> <span class="s1">&#39;2011-01-03&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>We force refreshing the index, so we can query it immediately.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">refresh</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>We may want to define a specific <a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-create-index.html">mapping</a>
for the index.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Tire</span><span class="o">.</span><span class="n">index</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>To do so, just pass a Hash containing the specified mapping to the <code>Index#create</code> method.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">create</span> <span class="ss">:mappings</span> <span class="o">=&gt;</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Specify for which type of documents this mapping should be used.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="ss">:article</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:properties</span> <span class="o">=&gt;</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Specify the type of the field, whether it should be analyzed, etc.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="ss">:id</span>       <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="ss">:index</span> <span class="o">=&gt;</span> <span class="s1">&#39;not_analyzed&#39;</span><span class="p">,</span> <span class="ss">:include_in_all</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Set the boost or analyzer settings for the field, &hellip; The <em>ElasticSearch</em> guide
has <a href="http://elasticsearch.org/guide/reference/mapping/index.html">more information</a>
about this. Proper mapping is key to efficient and effective search.
But don&rsquo;t fret about getting the mapping right the first time, you won&rsquo;t.
In most cases, the default, dynamic mapping is just fine for prototyping.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="ss">:title</span>    <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="ss">:analyzer</span> <span class="o">=&gt;</span> <span class="s1">&#39;snowball&#39;</span><span class="p">,</span> <span class="ss">:boost</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="o">.</span><span class="mi">0</span>             <span class="p">},</span>
        <span class="ss">:tags</span>     <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="ss">:analyzer</span> <span class="o">=&gt;</span> <span class="s1">&#39;keyword&#39;</span>                             <span class="p">},</span>
        <span class="ss">:content</span>  <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="ss">:analyzer</span> <span class="o">=&gt;</span> <span class="s1">&#39;czech&#39;</span>                               <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Bulk_Indexing'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Bulk_Indexing">&#182;</a>
        </div>
        <h3>Bulk Indexing</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>Of course, we may have large amounts of data, and adding them to the index one by one really isn&rsquo;t the best idea.
We can use <em>ElasticSearch&rsquo;s</em> <a href="http://www.elasticsearch.org/guide/reference/api/bulk.html">bulk API</a>
for importing the data.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>So, for demonstration purposes, let&rsquo;s suppose we have a simple collection of hashes to store.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">articles</span> <span class="o">=</span> <span class="o">[</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>Notice that such objects must have an <code>id</code> property!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="p">{</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;one&#39;</span><span class="p">,</span>   <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="o">]</span><span class="p">,</span>           <span class="ss">:published_on</span> <span class="o">=&gt;</span> <span class="s1">&#39;2011-01-01&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span>   <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:published_on</span> <span class="o">=&gt;</span> <span class="s1">&#39;2011-01-02&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;java&#39;</span><span class="o">]</span><span class="p">,</span>           <span class="ss">:published_on</span> <span class="o">=&gt;</span> <span class="s1">&#39;2011-01-02&#39;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;four&#39;</span><span class="p">,</span>  <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;php&#39;</span><span class="o">]</span><span class="p">,</span>    <span class="ss">:published_on</span> <span class="o">=&gt;</span> <span class="s1">&#39;2011-01-03&#39;</span> <span class="p">}</span>
<span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>We can just push them into the index in one go.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Tire</span><span class="o">.</span><span class="n">index</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span>
  <span class="n">import</span> <span class="n">articles</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>Of course, we can easily manipulate the documents before storing them in the index.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Tire</span><span class="o">.</span><span class="n">index</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span>
  <span class="n">delete</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>&hellip; by passing a block to the <code>import</code> method. The collection will
be available in the block argument.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">import</span> <span class="n">articles</span> <span class="k">do</span> <span class="o">|</span><span class="n">documents</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>We will capitalize every <em>title</em> and return the manipulated collection
back to the <code>import</code> method.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">documents</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span> <span class="n">document</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">document</span><span class="o">[</span><span class="ss">:title</span><span class="o">].</span><span class="n">capitalize</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">refresh</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Searching'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Searching">&#182;</a>
        </div>
        <h2>Searching</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>With the documents indexed and stored in the <em>ElasticSearch</em> database, we can search them, finally.</p>

<p><em>Tire</em> exposes the search interface via simple domain-specific language.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Simple_Query_String_Searches'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Simple_Query_String_Searches">&#182;</a>
        </div>
        <h3>Simple Query String Searches</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>We can do simple searches, like searching for articles containing “One” in their title.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">query</span> <span class="k">do</span>
    <span class="n">string</span> <span class="s2">&quot;title:one&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>The results:</p>

<pre><code>* One [tags: ruby]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> [tags: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>Or, we can search for articles published between January, 1st and January, 2nd.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">query</span> <span class="k">do</span>
    <span class="n">string</span> <span class="s2">&quot;published_on:[2011-01-01 TO 2011-01-02]&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>The results:</p>

<pre><code>* One [published: 2011-01-01]
* Two [published: 2011-01-02]
* Three [published: 2011-01-02]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> [published: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">published_on</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-36'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-36">&#182;</a>
        </div>
        <p>Notice, that we can access local variables from the <em>enclosing scope</em>.
(Of course, we may write the blocks in shorter notation.)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>We will define the query in a local variable named <code>q</code>&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;title:T*&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>&hellip; and we can use it inside the <code>query</code> block.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="n">q</span> <span class="p">}</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-39'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        <p>The results:</p>

<pre><code>* Two [tags: ruby, python]
* Three [tags: java]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> [tags: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-40'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-40">&#182;</a>
        </div>
        <p>Often, we need to access variables or methods defined in the <em>outer scope</em>.
To do that, we have to use a slight variation of the DSL.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-41'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-41">&#182;</a>
        </div>
        <p>Let&rsquo;s assume we have a plain Article class.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Article</span></pre></div>
      </td>
    </tr>
    <tr id='section-42'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-42">&#182;</a>
        </div>
        <p>We will define the query in a class method&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">q</span>
    <span class="s2">&quot;title:T*&quot;</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-43'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-43">&#182;</a>
        </div>
        <p>&hellip; and wrap the <em>Tire</em> search method.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">search</span></pre></div>
      </td>
    </tr>
    <tr id='section-44'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-44">&#182;</a>
        </div>
        <p>Notice how we pass the <code>search</code> object around as a block argument.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="no">Tire</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">search</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-45'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-45">&#182;</a>
        </div>
        <p>And we pass the query object in a similar matter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">search</span><span class="o">.</span><span class="n">query</span> <span class="k">do</span> <span class="o">|</span><span class="n">query</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-46'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-46">&#182;</a>
        </div>
        <p>Which means we can access the <code>q</code> class method.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">query</span><span class="o">.</span><span class="n">string</span> <span class="nb">self</span><span class="o">.</span><span class="n">q</span>
      <span class="k">end</span>
    <span class="k">end</span><span class="o">.</span><span class="n">results</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-47'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-47">&#182;</a>
        </div>
        <p>We may use any valid <a href="http://lucene.apache.org/java/3_0_3/queryparsersyntax.html">Lucene query syntax</a>
for the <code>query_string</code> queries.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-48'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-48">&#182;</a>
        </div>
        <p>For debugging our queries, we can display the JSON which is being sent to <em>ElasticSearch</em>.</p>

<pre><code>{"query":{"query_string":{"query":"title:T*"}}}
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Query:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span>
<span class="nb">puts</span> <span class="n">s</span><span class="o">.</span><span class="n">to_json</span></pre></div>
      </td>
    </tr>
    <tr id='section-49'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-49">&#182;</a>
        </div>
        <p>Or better yet, we may display a complete <code>curl</code> command to recreate the request in terminal,
so we can see the naked response, tweak request parameters and meditate on problems.</p>

<pre><code>curl -X POST "http://localhost:9200/articles/_search?pretty=true" \
     -d '{"query":{"query_string":{"query":"title:T*"}}}'
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Try the query in Curl:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span>
<span class="nb">puts</span> <span class="n">s</span><span class="o">.</span><span class="n">to_curl</span></pre></div>
      </td>
    </tr>
    <tr id='section-Logging'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Logging">&#182;</a>
        </div>
        <h2>Logging</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-51'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-51">&#182;</a>
        </div>
        <p>For debugging more complex situations, we can enable logging, so requests and responses
will be logged using this <code>curl</code>-friendly format.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Tire</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-52'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-52">&#182;</a>
        </div>
        <p>By default, at the <em>info</em> level, only the <code>curl</code>-format of request and
basic information about the response will be logged:</p>

<pre><code># 2011-04-24 11:34:01:150 [CREATE] ("articles")
#
curl -X POST "http://localhost:9200/articles"

# 2011-04-24 11:34:01:152 [200]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">logger</span> <span class="s1">&#39;elasticsearch.log&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-53'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-53">&#182;</a>
        </div>
        <p>For debugging, we can switch to the <em>debug</em> level, which will log the complete JSON responses.</p>

<p>That&rsquo;s very convenient if we want to post a recreation of some problem or solution
to the mailing list, IRC channel, etc.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">logger</span> <span class="s1">&#39;elasticsearch.log&#39;</span><span class="p">,</span> <span class="ss">:level</span> <span class="o">=&gt;</span> <span class="s1">&#39;debug&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-54'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-54">&#182;</a>
        </div>
        <p>Note that we can pass any <a href="http://www.ruby-doc.org/core/classes/IO.html"><code>IO</code></a>-compatible Ruby object as a logging device.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">logger</span> <span class="no">STDERR</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Configuration'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Configuration">&#182;</a>
        </div>
        <h2>Configuration</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-56'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-56">&#182;</a>
        </div>
        <p>As we have just seen with logging, we can configure various parts of <em>Tire</em>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Tire</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-57'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-57">&#182;</a>
        </div>
        <p>First of all, we can configure the URL for <em>ElasticSearch</em>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">url</span> <span class="s2">&quot;http://search.example.com&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-58'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-58">&#182;</a>
        </div>
        <p>Second, we may want to wrap the result items in our own class.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">class</span> <span class="nc">MySpecialWrapper</span><span class="p">;</span> <span class="k">end</span>
  <span class="n">wrapper</span> <span class="no">MySpecialWrapper</span></pre></div>
      </td>
    </tr>
    <tr id='section-59'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-59">&#182;</a>
        </div>
        <p>Finally, we can reset one or all configuration settings to their defaults.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">reset</span>

<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Complex_Searching'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Complex_Searching">&#182;</a>
        </div>
        <h2>Complex Searching</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-61'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-61">&#182;</a>
        </div>
        <p>Query strings are convenient for simple searches, but we may want to define our queries more expressively,
using the <em>ElasticSearch</em> <a href="http://www.elasticsearch.org/guide/reference/query-dsl/index.html">Query DSL</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-62'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-62">&#182;</a>
        </div>
        <p>Let&rsquo;s suppose we want to search for articles with specific <em>tags</em>, in our case “ruby” <em>or</em> “python”.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">query</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-63'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-63">&#182;</a>
        </div>
        <p>That&rsquo;s a great excuse to use a <a href="http://elasticsearch.org/guide/reference/query-dsl/terms-query.html"><em>terms</em></a>
query.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">terms</span> <span class="ss">:tags</span><span class="p">,</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-64'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-64">&#182;</a>
        </div>
        <p>The search, as expected, returns three articles, all tagged “ruby” — among other tags:</p>

<pre><code>* Two [tags: ruby, python]
* One [tags: ruby]
* Four [tags: ruby, php]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> [tags: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-65'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-65">&#182;</a>
        </div>
        <p>What if we wanted to search for articles tagged both “ruby” <em>and</em> “python”?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">query</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-66'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-66">&#182;</a>
        </div>
        <p>That&rsquo;s a great excuse to specify <code>minimum_match</code> for the query.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">terms</span> <span class="ss">:tags</span><span class="p">,</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:minimum_match</span> <span class="o">=&gt;</span> <span class="mi">2</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-67'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-67">&#182;</a>
        </div>
        <p>The search, as expected, returns one article, tagged with <em>both</em> “ruby” and “python”:</p>

<pre><code>* Two [tags: ruby, python]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> [tags: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Boolean_Queries'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Boolean_Queries">&#182;</a>
        </div>
        <h3>Boolean Queries</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-69'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-69">&#182;</a>
        </div>
        <p>Quite often, we need complex queries with boolean logic.
Instead of composing long query strings such as <code>tags:ruby OR tags:java AND NOT tags:python</code>,
we can use the <a href="http://www.elasticsearch.org/guide/reference/query-dsl/bool-query.html"><em>bool</em></a>
query.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">query</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-70'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-70">&#182;</a>
        </div>
        <p>In <em>Tire</em>, we can build <code>bool</code> queries declaratively, as usual.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">boolean</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-71'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-71">&#182;</a>
        </div>
        <p>Let&rsquo;s define a <code>should</code> (<code>OR</code>) query for <em>ruby</em>,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">should</span>   <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;tags:ruby&#39;</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-72'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-72">&#182;</a>
        </div>
        <p>as well as for <em>java</em>,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">should</span>   <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;tags:java&#39;</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-73'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-73">&#182;</a>
        </div>
        <p>while defining a <code>must_not</code> (<code>AND NOT</code>) query for <em>python</em>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">must_not</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;tags:python&#39;</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-74'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-74">&#182;</a>
        </div>
        <p>The search returns these documents:</p>

<pre><code>* One [tags: ruby]
* Three [tags: java]
* Four [tags: ruby, php]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> [tags: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-75'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-75">&#182;</a>
        </div>
        <p>The best thing about <code>boolean</code> queries is that we can very easily save these partial queries as Ruby blocks,
to mix and reuse them later, since we can call the <code>boolean</code> method multiple times.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-76'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-76">&#182;</a>
        </div>
        <p>Let&rsquo;s define the query for the <em>tags</em> property,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">tags_query</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">boolean</span><span class="o">|</span>
  <span class="n">boolean</span><span class="o">.</span><span class="n">should</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;tags:ruby&#39;</span> <span class="p">}</span>
  <span class="n">boolean</span><span class="o">.</span><span class="n">should</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;tags:java&#39;</span> <span class="p">}</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-77'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-77">&#182;</a>
        </div>
        <p>&hellip; and a query for the <em>published_on</em> property.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">published_on_query</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">boolean</span><span class="o">|</span>
  <span class="n">boolean</span><span class="o">.</span><span class="n">must</span>   <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;published_on:[2011-01-01 TO 2011-01-02]&#39;</span> <span class="p">}</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-78'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-78">&#182;</a>
        </div>
        <p>Now, we can use the <code>tags_query</code> on its own.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Tire</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="n">query</span> <span class="p">{</span> <span class="n">boolean</span> <span class="o">&amp;</span><span class="n">tags_query</span> <span class="p">}</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-79'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-79">&#182;</a>
        </div>
        <p>Or, we can combine it with the <code>published_on</code> query.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Tire</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">query</span> <span class="k">do</span>
    <span class="n">boolean</span> <span class="o">&amp;</span><span class="n">tags_query</span>
    <span class="n">boolean</span> <span class="o">&amp;</span><span class="n">published_on_query</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-80'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-80">&#182;</a>
        </div>
        <p><em>ElasticSearch</em> supports many types of <a href="http://www.elasticsearch.org/guide/reference/query-dsl/">queries</a>.</p>

<p>Eventually, <em>Tire</em> will support all of them. So far, only these are supported:</p>

<ul>
<li><a href="http://www.elasticsearch.org/guide/reference/query-dsl/query-string-query.html">string</a></li>
<li><a href="http://elasticsearch.org/guide/reference/query-dsl/term-query.html">term</a></li>
<li><a href="http://elasticsearch.org/guide/reference/query-dsl/terms-query.html">terms</a></li>
<li><a href="http://www.elasticsearch.org/guide/reference/query-dsl/bool-query.html">bool</a></li>
<li><a href="http://www.elasticsearch.org/guide/reference/query-dsl/match-all-query.html">all</a></li>
<li><a href="http://www.elasticsearch.org/guide/reference/query-dsl/ids-query.html">ids</a></li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Faceted_Search'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Faceted_Search">&#182;</a>
        </div>
        <h3>Faceted Search</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-82'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-82">&#182;</a>
        </div>
        <p><em>ElasticSearch</em> makes it trivial to retrieve complex aggregated data from our index/database,
so called <a href="http://www.elasticsearch.org/guide/reference/api/search/facets/index.html"><em>facets</em></a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-83'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-83">&#182;</a>
        </div>
        <p>Let&rsquo;s say we want to display article counts for every tag in the database.
For that, we&rsquo;ll use a <em>terms</em> facet.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-84'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-84">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-85'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-85">&#182;</a>
        </div>
        <p>We will search for articles whose title begins with letter “T”,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;title:T*&#39;</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-86'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-86">&#182;</a>
        </div>
        <p>and retrieve the counts “bucketed” by <code>tags</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">facet</span> <span class="s1">&#39;tags&#39;</span> <span class="k">do</span>
    <span class="n">terms</span> <span class="ss">:tags</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-87'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-87">&#182;</a>
        </div>
        <p>As we see, our query has found two articles, and if you recall our articles from above,
<em>Two</em> is tagged with “ruby” and “python”, while <em>Three</em> is tagged with “java”.</p>

<pre><code>Found 2 articles: Three, Two
</code></pre>

<p>The counts shouldn&rsquo;t surprise us:</p>

<pre><code>Counts by tag:
-------------------------
ruby       1
python     1
java       1
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;Found </span><span class="si">#{</span><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> articles: </span><span class="si">#{</span><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:title</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">puts</span> <span class="s2">&quot;Counts by tag:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">25</span>
<span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">facets</span><span class="o">[</span><span class="s1">&#39;tags&#39;</span><span class="o">][</span><span class="s1">&#39;terms&#39;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;term&#39;</span><span class="o">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;count&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-88'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-88">&#182;</a>
        </div>
        <p>These counts are based on the scope of our current query.
What if we wanted to display aggregated counts by <code>tags</code> across the whole database?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-89'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-89">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-90'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-90">&#182;</a>
        </div>
        <p>Let&rsquo;s repeat the search for “T”&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;title:T*&#39;</span> <span class="p">}</span>

  <span class="n">facet</span> <span class="s1">&#39;global-tags&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-91'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-91">&#182;</a>
        </div>
        <p>&hellip;but set the <code>global</code> scope for the facet in this case.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">terms</span> <span class="ss">:tags</span><span class="p">,</span> <span class="ss">:global</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-92'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-92">&#182;</a>
        </div>
        <p>We can even <em>combine</em> facets scoped to the current query
with globally scoped facets — we&rsquo;ll just use a different name.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">facet</span> <span class="s1">&#39;current-tags&#39;</span> <span class="k">do</span>
    <span class="n">terms</span> <span class="ss">:tags</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-93'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-93">&#182;</a>
        </div>
        <p>Aggregated results for the current query are the same as previously:</p>

<pre><code>Current query facets:
-------------------------
ruby       1
python     1
java       1
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;Current query facets:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">25</span>
<span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">facets</span><span class="o">[</span><span class="s1">&#39;current-tags&#39;</span><span class="o">][</span><span class="s1">&#39;terms&#39;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;term&#39;</span><span class="o">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;count&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-94'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-94">&#182;</a>
        </div>
        <p>On the other hand, aggregated results for the global scope include also
tags for articles not matched by the query, such as “java” or “php”:</p>

<pre><code>Global facets:
-------------------------
ruby       3
python     1
php        1
java       1
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;Global facets:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">25</span>
<span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">facets</span><span class="o">[</span><span class="s1">&#39;global-tags&#39;</span><span class="o">][</span><span class="s1">&#39;terms&#39;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;term&#39;</span><span class="o">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;count&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-95'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-95">&#182;</a>
        </div>
        <p><em>ElasticSearch</em> supports many advanced types of facets, such as those for computing statistics or geographical distance.</p>

<p>Eventually, <em>Tire</em> will support all of them. So far, only these are supported:</p>

<ul>
<li><a href="http://www.elasticsearch.org/guide/reference/api/search/facets/terms-facet.html">terms</a></li>
<li><a href="http://www.elasticsearch.org/guide/reference/api/search/facets/date-histogram-facet.html">date</a></li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-96'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-96">&#182;</a>
        </div>
        <p>We have seen that <em>ElasticSearch</em> facets enable us to fetch complex aggregations from our data.</p>

<p>They are frequently used for another feature, „faceted navigation“.
We can be combine query and facets with
<a href="http://elasticsearch.org/guide/reference/api/search/filter.html">filters</a>,
so the returned documents are restricted by certain criteria — for example to a specific category —,
but the aggregation calculations are still based on the original query.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Filtered_Search'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Filtered_Search">&#182;</a>
        </div>
        <h3>Filtered Search</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-98'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-98">&#182;</a>
        </div>
        <p>So, let&rsquo;s make our search a bit more complex. Let&rsquo;s search for articles whose titles begin
with letter “T”, again, but filter the results, so only the articles tagged “ruby”
are returned.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span>
  </pre></div>
      </td>
    </tr>
    <tr id='section-99'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-99">&#182;</a>
        </div>
        <p>We will use just the same <strong>query</strong> as before.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;title:T*&#39;</span> <span class="p">}</span> </pre></div>
      </td>
    </tr>
    <tr id='section-100'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-100">&#182;</a>
        </div>
        <p>But we will add a <em>terms</em> <strong>filter</strong> based on tags.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">filter</span> <span class="ss">:terms</span><span class="p">,</span> <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-101'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-101">&#182;</a>
        </div>
        <p>And, of course, our facet definition.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">facet</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="n">terms</span> <span class="ss">:tags</span> <span class="p">}</span>

<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-102'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-102">&#182;</a>
        </div>
        <p>We see that only the article <em>Two</em> (tagged “ruby” and “python”) is returned,
<em>not</em> the article <em>Three</em> (tagged “java”):</p>

<pre><code>* Two [tags: ruby, python]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> [tags: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-103'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-103">&#182;</a>
        </div>
        <p>The <em>count</em> for article <em>Three</em>&rsquo;s tags, “java”, on the other hand, <em>is</em> in fact included:</p>

<pre><code>Counts by tag:
-------------------------
ruby       1
python     1
java       1
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;Counts by tag:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">25</span>
<span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">facets</span><span class="o">[</span><span class="s1">&#39;tags&#39;</span><span class="o">][</span><span class="s1">&#39;terms&#39;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;term&#39;</span><span class="o">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;count&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Sorting'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Sorting">&#182;</a>
        </div>
        <h3>Sorting</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-105'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-105">&#182;</a>
        </div>
        <p>By default, the results are sorted according to their relevancy.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;tags:ruby&#39;</span> <span class="p">}</span> <span class="p">}</span>

<span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> &quot;</span> <span class="o">+</span>
       <span class="s2">&quot;[tags: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">; &quot;</span> <span class="o">+</span></pre></div>
      </td>
    </tr>
    <tr id='section-106'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-106">&#182;</a>
        </div>
        <p>The score is available as the <code>_score</code> property.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>       <span class="s2">&quot;score: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">_score</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-107'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-107">&#182;</a>
        </div>
        <p>The results:</p>

<pre><code>* One [tags: ruby; score: 0.30685282]
* Four [tags: ruby, php; score: 0.19178301]
* Two [tags: ruby, python; score: 0.19178301]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-108'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-108">&#182;</a>
        </div>
        <p>But, what if we want to sort the results based on some other criteria,
such as published date or product price? We can do that.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-109'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-109">&#182;</a>
        </div>
        <p>We will search for articles tagged “ruby”, again, &hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;tags:ruby&#39;</span> <span class="p">}</span> </pre></div>
      </td>
    </tr>
    <tr id='section-110'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-110">&#182;</a>
        </div>
        <p>&hellip; but will sort them by their <code>title</code>, in descending order.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">sort</span> <span class="p">{</span> <span class="n">title</span> <span class="s1">&#39;desc&#39;</span> <span class="p">}</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-111'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-111">&#182;</a>
        </div>
        <p>The results:</p>

<pre><code>* Two
* One
* Four
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-112'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-112">&#182;</a>
        </div>
        <p>Of course, it&rsquo;s possible to combine more fields in the sorting definition.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-113'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-113">&#182;</a>
        </div>
        <p>We will just get all articles in this case.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">query</span> <span class="p">{</span> <span class="n">all</span> <span class="p">}</span> 

  <span class="n">sort</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-114'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-114">&#182;</a>
        </div>
        <p>We will sort the results by their <code>published_on</code> property in <em>ascending</em> order (the default),</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">published_on</span></pre></div>
      </td>
    </tr>
    <tr id='section-115'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-115">&#182;</a>
        </div>
        <p>and by their <code>title</code> property, in <em>descending</em> order.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">title</span> <span class="s1">&#39;desc&#39;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-116'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-116">&#182;</a>
        </div>
        <p>The results:</p>

<pre><code>* One         (Published on: 2011-01-01)
* Two         (Published on: 2011-01-02)
* Three       (Published on: 2011-01-02)
* Four        (Published on: 2011-01-03)
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="si">}</span><span class="s2">  (Published on: </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">published_on</span> <span class="si">}</span><span class="s2">)&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Highlighting'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Highlighting">&#182;</a>
        </div>
        <h3>Highlighting</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-118'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-118">&#182;</a>
        </div>
        <p>Often, we want to highlight the snippets matching our query in the displayed results.
<em>ElasticSearch</em> provides rich
<a href="http://www.elasticsearch.org/guide/reference/api/search/highlighting.html">highlighting</a>
features, and <em>Tire</em> makes them trivial to use.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-119'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-119">&#182;</a>
        </div>
        <p>Let&rsquo;s search for documents containing word “Two” in their titles,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;title:Two&#39;</span> <span class="p">}</span> </pre></div>
      </td>
    </tr>
    <tr id='section-120'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-120">&#182;</a>
        </div>
        <p>and instruct <em>ElasticSearch</em> to highlight relevant snippets.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">highlight</span> <span class="ss">:title</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-121'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-121">&#182;</a>
        </div>
        <p>The results:</p>

<pre><code>Title: Two; Highlighted: &lt;em&gt;Two&lt;/em&gt;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;Title: </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2">; Highlighted: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">highlight</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-122'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-122">&#182;</a>
        </div>
        <p>We can configure many options for highlighting, such as:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Tire</span><span class="o">.</span><span class="n">search</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span>
  <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;title:Two&#39;</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-123'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-123">&#182;</a>
        </div>
        <p>• specify the fields to highlight</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">highlight</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:body</span></pre></div>
      </td>
    </tr>
    <tr id='section-124'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-124">&#182;</a>
        </div>
        <p>• specify their individual options</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">highlight</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:number_of_fragments</span> <span class="o">=&gt;</span> <span class="mi">0</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-125'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-125">&#182;</a>
        </div>
        <p>• or specify global highlighting options, such as the wrapper tag</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">highlight</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">:options</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:tag</span> <span class="o">=&gt;</span> <span class="s1">&#39;&lt;strong class=&quot;highlight&quot;&gt;&#39;</span> <span class="p">}</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-ActiveModel_Integration'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-ActiveModel_Integration">&#182;</a>
        </div>
        <h2>ActiveModel Integration</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-127'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-127">&#182;</a>
        </div>
        <p>As you can see, <a href="https://github.com/karmi/tire"><em>Tire</em></a> supports the
main features of <em>ElasticSearch</em> in Ruby.</p>

<p>It allows you to create and delete indices, add documents, search them, retrieve the facets, highlight the results,
and comes with a usable logging facility.</p>

<p>Of course, the holy grail of any search library is easy, painless integration with your Ruby classes, and,
most importantly, with ActiveRecord/ActiveModel classes.</p>

<p>Please, check out the <a href="https://github.com/karmi/tire/tree/master#readme">README</a> file for instructions
how to include <em>Tire</em>-based search in your models..</p>

<p>Send any feedback via Github issues, or ask questions in the <a href="irc://irc.freenode.net/#elasticsearch">#elasticsearch</a> IRC channel.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
